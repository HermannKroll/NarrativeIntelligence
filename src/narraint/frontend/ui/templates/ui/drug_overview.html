{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/../../static/css/../../static/css/drugOverview.css' %}">
{% endblock %}

{% block title %}Narrative Service{% endblock %}

{% block content %}
    {% csrf_token %}

    <div class="d-flex flex-row overflow-scroll">
        <div class="container-xl py-1 px-lg-2 ms-2 mt-2 me-0 ms-lg-5 me-lg-5 px-4 d-none d-lg-block col-lg-2 border rounded wide-size-sidebar">
            <p class="row g-0 fw-bolder fs-6 justify-content-center">Overview</p>
            <div class="row rounded mt-2 g-0 d-flex p-1 flex-nowrap shadow-sm" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="background-color: lightgrey">
                <div class="sidebar_entry_name overflow-hidden text-nowrap fs-0-85" >
                    Drug
                </div>
            </div>

            <div class="row rounded mt-2 g-0 d-flex p-1 flex-nowrap shadow-sm" onclick="scrollToElement('drugNetworkOverview')" style="background-color: darkgrey">
                <div class="sidebar_entry_name overflow-hidden text-nowrap fs-0-85" >
                    DTD Network
                </div>
            </div>

            <div class="row rounded mt-2 g-0 d-flex p-1 flex-nowrap shadow-sm" onclick="scrollToElement('KeywordCloud')" style="background-color: grey">
                <div class="sidebar_entry_name overflow-hidden text-nowrap fs-0-85" >
                    Keywords
                </div>
            </div>

            <div class="" id="sidebar_entries"></div>

            <div class="row rounded border mt-2 g-0 d-flex p-1 flex-nowrap shadow-sm" onclick="scrollToElement('RecentPapers')">
                <div class="col-8 text-nowrap text-truncate overflow-hidden text-nowrap fs-0-85" >
                    Recent Papers
                </div>
                <span class="badge rounded-pill bg-light text-dark w-auto border fs-0-75" id="linkRecentPapers"></span>
            </div>
        </div>

        <!-- Main page -->
        <div class="container-xl col-12 col-lg-10 px-2 px-sm-0 px-lg-5 mb-5 ms-lg-0 mx-xxl-auto wide-size-content">
            <!-- Searchbar -->
            <div class="row">
                <div class="container my-2">
                <div class="row col-6 offset-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id='drugInput' placeholder="Search for Drug...">
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="searchDrug()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search mb-1" viewBox="0 0 16 16">
                                    <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
            <!-- Content -->
            <div class="row">
                <div class="container" id="drugContent">
                    <div id="unknown_drug_name_tag" class="bg-danger d-none text-center fs-3 fw-bolder text-white w-fc p-2 mx-auto my-3 rounded"></div>
                    <div class="container d-flex flex-wrap flex-column-reverse flex-md-row border rounded py-2 g-2">
                        <img src="#" id="structure" class="drug-structure border mx-auto mx-md-0">
                        <!--src vom img setzen-->
                        <div class="general_info mx-auto ms-md-4">
                            <h2 id="name"></h2>
                            <!--text setzen-->
                            <table>
                                <tr>
                                    <td>Molecular Formula:</td>
                                    <td id="formular"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>Molecular Mass:</td>
                                    <td id="mass"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>ALogP:</td>
                                    <td id="drug_alogp"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>CX LogP:</td>
                                    <td id="drug_cxlogp"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>CX Acid pKA:</td>
                                    <td id="drug_cx_acid_pka"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>CX Basic pKA:</td>
                                    <td id="drug_cx_basic_pka"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>CX LogD pH 7.4:</td>
                                    <td id="drug_cx_logd"></td>
                                    <!--text setzen-->
                                </tr>
                                <tr>
                                    <td>See ChEMBL:</td>
                                    <td id="drug_chemblid"></td>
                                    <!--text setzen-->
                                </tr>

                            </table>
                        </div>
                    </div>

                    <!-- drug-target-disease-network -->
                    <div class="container border rounded mt-4" id="drugNetworkOverview">
                        <div class="row border-bottom p-1 gx-5 bg-light-grey">
                            <h5 class="col-12 gx-4 mt-1">Drug-Target-Disease Network</h5>
                        </div>
                        <div class="row col-12 py-1 vh-95 bg-white g-0" id="drugNetworkContainer">
                            <div class="row g-0 ms-1">
                                <input type="checkbox" class="btn-check" id="drugNetworkCheckboxDrug" onchange="updateNetworkGraph()" checked>
                                <label class="btn btn-drug me-1 col-auto" for="drugNetworkCheckboxDrug">Drug</label>

                                <input type="checkbox" class="btn-check" id="drugNetworkCheckboxTarget" onchange="updateNetworkGraph()" checked>
                                <label class="btn btn-target mx-1 col-auto h" for="drugNetworkCheckboxTarget">Target</label>

                                <input type="checkbox" class="btn-check" id="drugNetworkCheckboxDisease" onchange="updateNetworkGraph()" checked>
                                <label class="btn btn-disease mx-1 col-auto" for="drugNetworkCheckboxDisease">Disease</label>
                            </div>
                            <div class="row p-0 my-1 g-0 h-graph align-items-center" id="drugNetworkLoading">
                                <div class="spinner-border mx-auto my-auto" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <div class="row p-0 my-1 g-0 bg-light-grey h-graph dp-none" id="drugNetworkContent"></div>
                            <div class="row g-0 h-auto">
                                <div class="col-auto ms-auto me-1 my-auto" id="drugNetworkAmount" >Top 6</div>
                                <div class="col-auto range me-1 mt-auto mb-1">
                                    <input type="range" class="my-auto text-secondary" id="drugNetworkSlider" min="5" max="20" value="6" step="1" oninput="updateNetworkGraph()">
                                </div>
                                <button class="col-auto btn btn-secondary me-1" onclick="centerNetwork(network)">
                                    Center
                                </button>
                                <button class="col-auto btn btn-secondary me-1" onclick="toggleFullscreenNetworkGraph('drugNetwork')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen mb-1" viewBox="0 0 16 16">
                                        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"></path>
                                    </svg>
                                    <span type="button" id="drugNetworkFullscreen">Fullscreen</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="container border rounded mt-4" id="KeywordCloud">
                        <div class="row border-bottom p-1 gx-5 bg-light-grey">
                            <h5 class="col-12 gx-4 mt-1">Keyword Cloud</h5>
                        </div>
                        <div class="row my-5 align-items-center" id="wordCloudLoading">
                            <div class="spinner-border mx-auto my-auto" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <ul class="cloud" id="wordCloudContent"></ul>
                    </div>

                    <div id="overview_entries"></div>

                    <div class="container border rounded mt-4" id="RecentPapers">
                        <div class="row border-bottom p-1 gx-5 bg-light-grey">
                            <h5 class="col-12 gx-4 mt-1">Recent Papers</h5>
                        </div>
                        <div class="row my-5 align-items-center" id="newsLoading">
                            <div class="spinner-border mx-auto my-auto" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>

                        <div class="row news_bottom" id="newsContent"></div>

                        <a class="row border-top ps-2 py-1 gx-5" id="morePaperRef" style="display: none" target="_blank">
                            More paper
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="popup" id="newsPopup">
        <div class="newsdetail">
            <div class="top">
                <a id="paperLink">View Paper</a>
                <a id="paperTab">Open in a new tab
                    <img src="{% static 'assets/searchicon.svg' %}">
                </a>
                <div onclick="hideDetail()">
                    <img src="{% static 'assets/close.svg' %}">
                </div>
            </div>
            <div class="bottom">
                <div class="checkbox" id="newsCheckbox"></div>
                <div class="paper">
                    <h2 id="paperTitle"></h2>
                    <p class="author" id="paperAuthor"></p>
                    <p class="journal" id="paperJournal"></p>
                    <p class="date" id="paperDate"></p>
                    <p class="abstract" id="paperAbstract"></p>

                    <div id="classifications">
                        <h2 id="classificationHeader">Classifications</h2>
                        <div id="classificationDiv"></div>
                        <p id="classificationInfo"
                           style="margin-top: 10px; font-size:15px;">
                            <em>(1,10) means text passage 1-10</em></p>
                    </div>
                </div>
                <div class="graphContainer" id="graphContainer">
                    <div class="graphNetwork" id="paperGraph"></div>
                    <div class="graphFooter">
                        <button class="btn btn-secondary me-1 ms-auto" onclick="centerNetwork(papernetwork)">
                            Center
                        </button>
                        <button class="btn btn-secondary me-1" onclick="toggleFullscreenNetworkGraph('graph')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen mb-1" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"></path>
                            </svg>
                            <span type="button" id="graphFullscreen">Fullscreen</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- feedback elements -->
    <button type="button" class="btn btn-primary feedbackbtn" id="feedback_button"
            onclick="openFeedback()" data-html2canvas-ignore="true">
        <span id="feedbackbtn_text">Feedback</span>
        <span class="spinner-border spinner-border-sm" id="reportSpinner" role="status" style="display: none"></span>
    </button>
    <div class="popup" id="feedbackPopup">
        <div class="feedback_window" role="document">
            <div class="feedback_header" id="header">
                <h3 class="">Send feedback with screenshot</h3>
                <div onclick="closeFeedback()">
                    <img src="{% static 'assets/close.svg' %}">
                </div>
            </div>
            <div class="feedback_body">
                <div class="feedback_screen_wrap">
                    <div class="" id="screenshotContainer">
                        <img src="null" id="screenshot"
                             class="">
                        <canvas class=""
                                 id="screenshotCanvas"></canvas>
                    </div>
                </div>
                <div class="">
                    <div class="feedback_button" onclick="resetCanvas()"
                         style="background-color: #9f9f9f">Reset
                    </div>
                </div>

                <p>Please mark the problematic section on the image above and/or describe the problem you have
                    encountered:</p>
                <textarea class="" id="feedbackText" rows="3"></textarea>
            </div>
            <div class="feedback_footer">
                <div class="feedback_button" onclick="closeFeedback()"
                    style="background-color: #9f9f9f; margin-right: 1%">Cancel</div>
                <div class="feedback_button" onclick="closeFeedback(true)"
                   style="background-color: #3180ff">Send Report</button>
                </div>
            </div>
        </div>
    </div>

    <noscript>
        <div class="noscript">
            <div>
                This website requires JavaScript enabled to function properly.
            </div>
        </div>
    </noscript>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        const autocompletion_url = "{% url 'autocompletion' %}";
        const url_query = "/";
        const url_query_sub_count = "{% url 'query_sub_count' %}";
        const url_query_document_ids_for_entity = "{% url 'document_ids_for_entity' %}";
        const url_term_2_entity = "{% url 'term_to_entity' %}";
        const url_document_graph = "{% url 'document_graph' %}";
        const url_narrative_documents = "{% url 'narrative_documents' %}";
        const url_chembl_phase = "{% static 'assets/chembl_phase_' %}";
        const url_chembl_phase_new = "{% static 'assets/verification_new.svg' %}";
        const url_loading_gif = "{% static 'assets/loading.gif' %}";
        const url_drug_overview_idx = "{% url 'drug_overview_index' %}"
        const url_feedback_report = "{% url 'report' %}";
        const url_keywords = "{% url 'keywords' %}";
        const url_paper_view_log = "{% url 'paper_view_log' %}";

        const url_drug_search = "{% url 'drug_search_log' %}";
        const url_substance_href = "{% url 'drug_substance_forward_log' %}";
        const url_chembl_phase_href = "{% url 'drug_chembl_phase_log' %}";

        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.3/async.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="{% static 'js/paper.js' %}?version=4" type="text/javascript"></script>
    <script src="{% static 'js/drugOverviewClient.js' %}?version=8" type="text/javascript"></script>
    <script src="{% static 'js/drugOverviewAutoComplete.js' %}?version=4" type="text/javascript"></script>
    <script src="{% static 'js/feedback.js' %}?version=5" type="text/javascript"></script>
{% endblock %}