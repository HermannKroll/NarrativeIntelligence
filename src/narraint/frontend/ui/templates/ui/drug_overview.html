{% extends 'base.html' %}
{% load static %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/../../static/css/../../static/css/drugOverview.css' %}">
{% endblock %}

{% block title %}Narrative Service{% endblock %}

{% block content %}
    {% csrf_token %}

    <div class="searchbarContainer">
        <div class="searchbar">
            <input type="text" id='drugInput' placeholder="Search for Drug...">
            <div onclick="searchDrug()" class="button">
                <img src="{% static 'assets/searchicon.svg' %}">
            </div>
        </div>
    </div>

    <div class="sidebar">
        <p>Overview</p>
        <div class="link" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" style="background-color: lightgrey">
            <div class="sidebar_entry_name" >
                Drug
            </div>
        </div>

        <div class="link" onclick="scrollToElement('drugNetworkOverview')" style="background-color: darkgrey">
            <div class="sidebar_entry_name" >
                DTD Network
            </div>
        </div>

        <div class="link" onclick="scrollToElement('KeywordCloud')" style="background-color: grey">
            <div class="sidebar_entry_name" >
                Keywords
            </div>
        </div>

        <div id="sidebar_entries"></div>

        <div class="link" onclick="scrollToElement('RecentPapers')">
            <div class="sidebar_entry_name" >
                Recent Papers
            </div>
            <div class="sidebar_entry_count" id="linkRecentPapers"></div>
        </div>
    </div>

    <div class="content" id="drugContent">
        <div id="unknown_drug_name_tag" class="error_msg"></div>
        <div class="top_container">
            <img src="#" id="structure">
            <!--src vom img setzen-->
            <div class="general_info">
                <h1 id="name"></h1>
                <!--text setzen-->
                <table>
                    <tr>
                        <td>Molecular Formula:</td>
                        <td id="formular"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>Molecular Mass:</td>
                        <td id="mass"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>ALogP:</td>
                        <td id="drug_alogp"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>CX LogP:</td>
                        <td id="drug_cxlogp"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>CX Acid pKA:</td>
                        <td id="drug_cx_acid_pka"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>CX Basic pKA:</td>
                        <td id="drug_cx_basic_pka"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>CX LogD pH 7.4:</td>
                        <td id="drug_cx_logd"></td>
                        <!--text setzen-->
                    </tr>
                    <tr>
                        <td>See ChEMBL:</td>
                        <td id="drug_chemblid"></td>
                        <!--text setzen-->
                    </tr>

                </table>
            </div>
        </div>

        <!-- drug-target-disease-network -->
        <div class="box searchbox" id="drugNetworkOverview" style="height:
        fit-content">
            <div class="top_searchbox">
                <div class="top_searchbox_left">
                    <h2>Drug-Target-Disease Network</h2>
                </div>
            </div>
            <div class="drugNetworkContainer" id="drugNetworkContainer">
                <div class="drugNetworkSelection">
                    <div class="drugNetworkButton" style="background-color: #ff8181" onchange="updateNetworkGraph()">
                        <label><input id="drugNetworkCheckboxDrug" type="checkbox" checked>Drug</label>
                    </div>
                    <div class="drugNetworkButton" style="background-color: #aeff9a" onchange="updateNetworkGraph()">
                        <label><input id="drugNetworkCheckboxDisease" type="checkbox" checked>Disease</label>
                    </div>
                    <div class="drugNetworkButton" style="background-color: #b88cff" onchange="updateNetworkGraph()">
                        <label><input id="drugNetworkCheckboxTarget" type="checkbox" checked>Target</label>
                    </div>
                </div>
                <div class="loading" id="drugNetworkLoading" style="height: calc(100% - 5em); align-items: center">
                    <img src="{% static 'assets/loading.gif' %}" alt="Loading...">
                </div>
                <div class="drugNetworkContent" id="drugNetworkContent"></div>
                <div class="drugNetworkFooter">
                    <div id="drugNetworkAmount" class="ms-auto me-1 my-auto">Top 6</div>
                    <div class="range me-1 mt-auto mb-1">
                        <input type="range" class="my-auto text-secondary" id="drugNetworkSlider" min="5" max="20" value="6" step="1" oninput="updateNetworkGraph()">
                    </div>
                    <button class="btn btn-secondary me-1" onclick="centerNetwork(network)">
                        Center
                    </button>
                    <button class="btn btn-secondary me-1" onclick="toggleFullscreenNetworkGraph('drugNetwork')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen mb-1" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"></path>
                        </svg>
                        <span type="button" id="drugNetworkFullscreen">Fullscreen</span>
                    </button>
                </div>
            </div>
        </div>

        <div class="box word_cloud searchbox" id="KeywordCloud">
            <div class="top_searchbox">
                <div class="top_searchbox_left">
                    <h2>Keyword Cloud</h2>
                </div>
            </div>
            <div class="loading" id="wordCloudLoading">
                <img src="{% static 'assets/loading.gif' %}" alt="Loading...">
            </div>
            <ul class="cloud" id="wordCloudContent"></ul>
        </div>
        <div id="overview_entries"></div>
        <div class="box news" id="RecentPapers">
            <h2>Recent Papers</h2>
            <div class="loading" id="newsLoading">
                <img src="{% static 'assets/loading.gif' %}">
            </div>
            <div class="news_bottom" id="newsContent">
                <!--Papers hier einfuegen-->
            </div>

            <a id="morePaperRef" style="display: none" target="_blank">
                More paper
            </a>

        </div>
    </div>

    <div class="popup" id="newsPopup">
        <div class="newsdetail">
            <div class="top">
                <a id="paperLink">View Paper</a>
                <a id="paperTab">Open in a new tab
                    <img src="{% static 'assets/searchicon.svg' %}">
                </a>
                <div onclick="hideDetail()">
                    <img src="{% static 'assets/close.svg' %}">
                </div>
            </div>
            <div class="bottom">
                <div class="checkbox" id="newsCheckbox"></div>
                <div class="paper">
                    <h2 id="paperTitle"></h2>
                    <p class="author" id="paperAuthor"></p>
                    <p class="journal" id="paperJournal"></p>
                    <p class="date" id="paperDate"></p>
                    <p class="abstract" id="paperAbstract"></p>

                    <div id="classifications">
                        <h2 id="classificationHeader">Classifications</h2>
                        <div id="classificationDiv"></div>
                        <p id="classificationInfo"
                           style="margin-top: 10px; font-size:15px;">
                            <em>(1,10) means text passage 1-10</em></p>
                    </div>
                </div>
                <div class="graphContainer" id="graphContainer">
                    <div class="graphNetwork" id="paperGraph"></div>
                    <div class="graphFooter">
                        <button class="btn btn-secondary me-1 ms-auto" onclick="centerNetwork(papernetwork)">
                            Center
                        </button>
                        <button class="btn btn-secondary me-1" onclick="toggleFullscreenNetworkGraph('graph')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen mb-1" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"></path>
                            </svg>
                            <span type="button" id="graphFullscreen">Fullscreen</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- feedback elements -->
    <button type="button" class="btn btn-primary feedbackbtn" id="feedback_button"
            onclick="openFeedback()" data-html2canvas-ignore="true">
        <span id="feedbackbtn_text">Feedback</span>
        <span class="spinner-border spinner-border-sm" id="reportSpinner" role="status" style="display: none"></span>
    </button>
    <div class="popup" id="feedbackPopup">
        <div class="feedback_window" role="document">
            <div class="feedback_header" id="header">
                <h3 class="">Send feedback with screenshot</h3>
                <div onclick="closeFeedback()">
                    <img src="{% static 'assets/close.svg' %}">
                </div>
            </div>
            <div class="feedback_body">
                <div class="feedback_screen_wrap">
                    <div class="" id="screenshotContainer">
                        <img src="null" id="screenshot"
                             class="">
                        <canvas class=""
                                 id="screenshotCanvas"></canvas>
                    </div>
                </div>
                <div class="">
                    <div class="feedback_button" onclick="resetCanvas()"
                         style="background-color: #9f9f9f">Reset
                    </div>
                </div>

                <p>Please mark the problematic section on the image above and/or describe the problem you have
                    encountered:</p>
                <textarea class="" id="feedbackText" rows="3"></textarea>
            </div>
            <div class="feedback_footer">
                <div class="feedback_button" onclick="closeFeedback()"
                    style="background-color: #9f9f9f; margin-right: 1%">Cancel</div>
                <div class="feedback_button" onclick="closeFeedback(true)"
                   style="background-color: #3180ff">Send Report</button>
                </div>
            </div>
        </div>
    </div>

    <noscript>
        <div class="noscript">
            <div>
                This website requires JavaScript enabled to function properly.
            </div>
        </div>
    </noscript>
{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        const autocompletion_url = "{% url 'autocompletion' %}";
        const url_query = "/";
        const url_query_sub_count = "{% url 'query_sub_count' %}";
        const url_query_document_ids_for_entity = "{% url 'document_ids_for_entity' %}";
        const url_term_2_entity = "{% url 'term_to_entity' %}";
        const url_document_graph = "{% url 'document_graph' %}";
        const url_narrative_documents = "{% url 'narrative_documents' %}";
        const url_chembl_phase = "{% static 'assets/chembl_phase_' %}";
        const url_chembl_phase_new = "{% static 'assets/verification_new.svg' %}";
        const url_loading_gif = "{% static 'assets/loading.gif' %}";
        const url_drug_overview_idx = "{% url 'drug_overview_index' %}"
        const url_feedback_report = "{% url 'report' %}";
        const url_keywords = "{% url 'keywords' %}";
        const url_paper_view_log = "{% url 'paper_view_log' %}";

        const url_drug_search = "{% url 'drug_search_log' %}";
        const url_substance_href = "{% url 'drug_substance_forward_log' %}";
        const url_chembl_phase_href = "{% url 'drug_chembl_phase_log' %}";

        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    </script>

    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/3.2.3/async.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <script src="{% static 'js/paper.js' %}?version=4" type="text/javascript"></script>
    <script src="{% static 'js/drugOverviewClient.js' %}?version=8" type="text/javascript"></script>
    <script src="{% static 'js/drugOverviewAutoComplete.js' %}?version=4" type="text/javascript"></script>
    <script src="{% static 'js/feedback.js' %}?version=5" type="text/javascript"></script>
{% endblock %}